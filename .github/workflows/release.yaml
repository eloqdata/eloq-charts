name: Release EloqData Charts

# Automatic release on main branch push
# Manual release on other branches via workflow_dispatch (publishes dev versions)
on:
  push:
    branches:
      - main
    paths:
      - "charts/**"
      - ".github/workflows/release.yaml"
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Add Helm repositories
        run: |
          helm repo add jetstack https://charts.jetstack.io
          helm repo update

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Get commit SHA
        id: sha
        run: echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Determine if main branch
        id: branch
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "IS_MAIN=true" >> $GITHUB_OUTPUT
          else
            echo "IS_MAIN=false" >> $GITHUB_OUTPUT
          fi

      - name: Package and Push All Charts to OCI Registry
        env:
          IS_MAIN: ${{ steps.branch.outputs.IS_MAIN }}
          SHORT_SHA: ${{ steps.sha.outputs.SHORT_SHA }}
        run: |
          for chart_dir in charts/*/; do
            if [ -f "${chart_dir}Chart.yaml" ]; then
              chart_name=$(basename "$chart_dir")
              echo "Processing chart: $chart_name"

              # Build dependencies
              helm dependency build "$chart_dir"

              if [ "$IS_MAIN" = "true" ]; then
                # Main branch: publish official release version
                VERSION=$(grep '^version:' "${chart_dir}Chart.yaml" | awk '{print $2}')
                echo "Using Chart.yaml version: $VERSION"
              else
                # Non-main branches (manual dispatch only): publish dev version
                VERSION="0.0.0-${SHORT_SHA}"
                echo "Using dev version: $VERSION"
              fi

              # Package and push
              helm package "$chart_dir" --version "$VERSION"
              chart_package="${chart_name}-${VERSION}.tgz"
              helm push "$chart_package" oci://ghcr.io/${{ github.repository_owner }}/charts

              echo "✅ Pushed $chart_name:$VERSION to ghcr.io/${{ github.repository_owner }}/charts"
            fi
          done

      - name: Package All Charts for GitHub Release
        env:
          IS_MAIN: ${{ steps.branch.outputs.IS_MAIN }}
          SHORT_SHA: ${{ steps.sha.outputs.SHORT_SHA }}
        run: |
          mkdir -p .release-packages
          for chart_dir in charts/*/; do
            if [ -f "${chart_dir}Chart.yaml" ]; then
              chart_name=$(basename "$chart_dir")

              if [ "$IS_MAIN" = "true" ]; then
                VERSION=$(grep '^version:' "${chart_dir}Chart.yaml" | awk '{print $2}')
              else
                VERSION="0.0.0-${SHORT_SHA}"
              fi

              helm package "$chart_dir" --version "$VERSION" -d .release-packages
              echo "✅ Packaged $chart_name:$VERSION for GitHub Release"
            fi
          done

      - name: Get versions for release
        if: github.ref == 'refs/heads/main'
        id: versions
        run: |
          operator_version=$(grep '^version:' charts/eloq-operator/Chart.yaml | awk '{print $2}')
          echo "OPERATOR_VERSION=$operator_version" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.versions.outputs.OPERATOR_VERSION }}
          name: Release v${{ steps.versions.outputs.OPERATOR_VERSION }}
          files: .release-packages/*.tgz
          generate_release_notes: true
          body: |
            ## EloqData Helm Charts Release (OCI/GHCR)

            **Commit**: ${{ github.sha }}
            **Branch**: main

            ### Chart Versions:
            - eloq-operator: `${{ steps.versions.outputs.OPERATOR_VERSION }}`

            ### Installation using OCI Registry (GHCR):

            ```bash
            # Authenticate
            export GITHUB_TOKEN=your_github_token
            echo $GITHUB_TOKEN | helm registry login ghcr.io -u your-username --password-stdin

            # Install eloq-operator
            helm install eloq-operator oci://ghcr.io/${{ github.repository_owner }}/charts/eloq-operator --version ${{ steps.versions.outputs.OPERATOR_VERSION }}
            ```
